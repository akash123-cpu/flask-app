<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Data Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .data-table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-top: 20px;
    }
    table.data-table {
      width: 100%;
      border-collapse: collapse;
    }
    table.data-table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10;
      border-bottom: 2px solid #ccc;
      padding: 8px;
    }
    table.data-table tbody td {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    #downloadButtons {
      display: none;
      margin-top: 15px;
    }
  </style>
</head>

<body class="container mt-4">
  <!-- Navigation -->
  <nav class="mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Data</a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Dashboard</a>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger float-end">Logout</a>
  </nav>

  <h2 class="mb-4">Select and View Data</h2>

  <!-- Data Selection Form -->
  <form id="dataForm" class="border p-3 rounded bg-light">
    <div class="mb-3">
      <label for="databaseSelect" class="form-label">Database</label>
      <select id="databaseSelect" name="database_name" class="form-select" required>
        <option value="">-- Select Database --</option>
        {% for db in database_names %}
          <option value="{{ db }}">{{ db }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="loggerSelect" class="form-label">Data Logger ID</label>
      <select id="loggerSelect" name="logger_id" class="form-select" required>
        <option value="">-- Select Logger ID --</option>
      </select>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" id="startDate" name="start_date" class="form-control" required />
      </div>
      <div class="col">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" id="endDate" name="end_date" class="form-control" required />
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Load Data</button>
  </form>

  <!-- Download Buttons -->
  <div id="downloadButtons" class="text-end">
    <hr />
    <button id="downloadCSV" class="btn btn-success me-2">ðŸ“„ CSV</button>
    <button id="downloadExcel" class="btn btn-info me-2">ðŸ“Š Excel</button>
    <button id="downloadPDF" class="btn btn-danger">ðŸ§¾ PDF</button>
  </div>

  <!-- Table Display -->
  <div id="dataTableContainer" class="data-table-container mt-4"></div>

  <!-- JavaScript -->
  <script>
    $(document).ready(function () {
      function buildQueryParams() {
        const logger_id = $('#loggerSelect').val();
        const start_date = $('#startDate').val();
        const end_date = $('#endDate').val();
        if (!logger_id || !start_date || !end_date) return null;
        return `?logger_id=${encodeURIComponent(logger_id)}&start_date=${encodeURIComponent(start_date)}&end_date=${encodeURIComponent(end_date)}`;
      }

      $('#databaseSelect').change(function () {
        const dbName = $(this).val();
        $('#loggerSelect').html('<option value="">-- Select Logger ID --</option>');
        $('#dataTableContainer').empty();
        $('#downloadButtons').hide();

        if (dbName) {
          $.post("{{ url_for('get_station_logger_info') }}", { database_name: dbName }, function (res) {
            if (res.logger_ids.length > 0) {
              res.logger_ids.forEach(function (id) {
                $('#loggerSelect').append(`<option value="${id}">${id}</option>`);
              });
            } else {
              $('#loggerSelect').html('<option value="">No Logger IDs Found</option>');
            }
          });
        }
      });

      $('#loggerSelect').change(function () {
        const loggerId = $(this).val();
        $('#dataTableContainer').empty();
        $('#downloadButtons').hide();

        if (loggerId) {
          $.post("{{ url_for('get_dates') }}", { logger_id: loggerId }, function (data) {
            if (data.length) {
              $('#startDate').attr({ min: data[0], max: data[data.length - 1] }).val('');
              $('#endDate').attr({ min: data[0], max: data[data.length - 1] }).val('');
            } else {
              alert("No available dates for this logger.");
            }
          });
        }
      });

      $('#dataForm').submit(function (e) {
        e.preventDefault();
        $('#dataTableContainer').html('<div class="text-muted">Loading data...</div>');
        $('#downloadButtons').hide();

        $.post("{{ url_for('get_data') }}", $(this).serialize(), function (data) {
          $('#dataTableContainer').html(data);
          if (!data.includes('No data found')) {
            $('#downloadButtons').show();
          }
        }).fail(function () {
          $('#dataTableContainer').html('<div class="alert alert-danger">Failed to load data.</div>');
        });
      });

      // Fixed download handlers using static URLs
      $('#downloadCSV').click(function () {
        const params = buildQueryParams();
        if (params) {
          window.open("{{ url_for('download_csv') }}" + params, '_blank');
        } else {
          alert('Please select logger and date range first.');
        }
      });

      $('#downloadExcel').click(function () {
        const params = buildQueryParams();
        if (params) {
          window.open("{{ url_for('download_excel') }}" + params, '_blank');
        } else {
          alert('Please select logger and date range first.');
        }
      });

      $('#downloadPDF').click(function () {
        const params = buildQueryParams();
        if (params) {
          window.open("{{ url_for('download_pdf') }}" + params, '_blank');
        } else {
          alert('Please select logger and date range first.');
        }
      });
    });
  </script>
</body>
</html>
